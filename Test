(function ($, $document, author) {
    "use strict";

    $document.on("foundation-contentloaded", function (e) {
        Coral.commons.ready(this, function (el) {
            var $textField = $(".bcusReadOnlyDialogField");
            $textField.prop("readonly", true);
            $textField.attr("readonly", true);

            // Remove Delete Button if needed
            $(".bcus-hide-multifield-delete button.js-coral-Multifield-remove.coral-Multifield-remove").remove(); // remove coral2 delete icon
            $(".bcus-hide-multifield-delete button.coral3-Button.coral3-Button--quiet.coral3-Multifield-remove").remove(); // remove coral3 delete icon

            $(".vanity-url-delete .coral3-Multifield-item button.coral3-Button.coral3-Multifield-remove").remove();
            $(".deleteVanityUrlAssociation button.coral3-Multifield-remove").click(function () {
                if ($(this).parent().find("input.primaryOfferProductId").length) {
                    var offerProdId = $(this).parent().find("input.primaryOfferProductId").val();

                    //Delete Vanity Url
                    $("input[name='./sling:vanityPath']").each(function () {
                        if (this.value.indexOf(offerProdId) !== -1) {
                            $(this).parent().closest("coral-multifield-item").remove();
                            $(this).parent().closest("li").remove(); // remove coral2 vanity-url field
                        }
                    });

                    // --- extra MPC logic (added, original code above unchanged) ---
                    if ($("input[name='./sling:vanityPath']").length === 0) {
                        return;
                    }

                    $.ajax({
                        url: "/bin/bcuspublic/offerproductmpccodes",
                        type: "GET",
                        dataType: "json",
                        data: {
                            offerProductId: offerProdId
                        }
                    }).done(function (mpcCodes) {

                        if (!mpcCodes || !mpcCodes.length) {
                            return;
                        }

                        var mpcSet = new Set(mpcCodes);

                        $("input[name='./sling:vanityPath']").each(function () {
                            var vanity = this.value || "";
                            var idx = vanity.lastIndexOf("/");
                            var lastSeg = (idx === -1) ? vanity : vanity.substring(idx + 1);

                            if (mpcSet.has(lastSeg)) {
                                $(this).parent().closest("coral-multifield-item").remove();
                                $(this).parent().closest("li").remove();
                            }
                        });
                    });
                }
            });

            // Remove Add Button
            $(".bcus-hide-multifield-add button.js-coral-Multifield-add.coral-Multifield-add.coral-Button").remove();
            $(".bcus-hide-multifield-add button.coral3-Button.coral3-Button--secondary").remove();
        });
    });

})(jQuery, jQuery(document), Granite.author);
