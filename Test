package com.bcuspublic.wcm.servlet.offerproduct;

import static com.bcuspublic.wcm.constants.OfferProductConstants.OFFER_PRODUCT_ID_QUERY_PARAM;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import java.io.ByteArrayOutputStream;
import java.io.PrintWriter;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import javax.servlet.http.HttpServletResponse;

import org.apache.sling.api.resource.ResourceResolver;
import org.apache.sling.api.servlets.SlingHttpServletRequest;
import org.apache.sling.api.servlets.SlingHttpServletResponse;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockedStatic;
import org.mockito.junit.MockitoJUnitRunner;
import org.mockito.Mockito;

import com.bcuspublic.wcm.service.common.ResourceResolvers;
import com.bcuspublic.wcm.service.offerproduct.OfferProductUtil;
import com.bcuspublic.wcm.service.common.SubService;
import org.json.JSONArray;

@RunWith(MockitoJUnitRunner.class)
public class FetchMpcCodesServletTest {

    @InjectMocks
    private FetchMpcCodesServlet servlet;

    @Mock
    private ResourceResolvers resourceResolvers;

    @Mock
    private ResourceResolver resourceResolver;

    @Mock
    private SlingHttpServletRequest request;

    @Mock
    private SlingHttpServletResponse response;

    /**
     * Helper to create a PrintWriter that writes into a String.
     */
    private PrintWriter prepareWriter(ByteArrayOutputStream out) throws Exception {
        PrintWriter writer = new PrintWriter(out, true);
        when(response.getWriter()).thenReturn(writer);
        return writer;
    }

    @Test
    public void testDoGet_withValidOfferProductId_returnsJsonArray() throws Exception {
        String offerProductId = "ff64552f-5119-42ef-9485-656d1ad239e19";
        List<String> mpcCodes = Arrays.asList("mpc1", "mpc2");

        when(resourceResolvers.getResourceResolver(SubService.READ_CONTENT))
                .thenReturn(resourceResolver);
        when(request.getParameter(OFFER_PRODUCT_ID_QUERY_PARAM)).thenReturn(offerProductId);

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        prepareWriter(out);

        try (MockedStatic<OfferProductUtil> mockedStatic =
                     Mockito.mockStatic(OfferProductUtil.class)) {

            mockedStatic.when(() ->
                            OfferProductUtil.getMpcCodeList(offerProductId, resourceResolver))
                    .thenReturn(mpcCodes);

            servlet.doGet(request, response);

            mockedStatic.verify(() ->
                    OfferProductUtil.getMpcCodeList(offerProductId, resourceResolver));

            String json = out.toString();
            assertEquals(new JSONArray(mpcCodes).toString(), json.trim());
        }
    }

    @Test
    public void testDoGet_withValidOfferProductId_emptyList_returnsEmptyJsonArray()
            throws Exception {

        String offerProductId = "some-id";

        when(resourceResolvers.getResourceResolver(SubService.READ_CONTENT))
                .thenReturn(resourceResolver);
        when(request.getParameter(OFFER_PRODUCT_ID_QUERY_PARAM)).thenReturn(offerProductId);

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        prepareWriter(out);

        try (MockedStatic<OfferProductUtil> mockedStatic =
                     Mockito.mockStatic(OfferProductUtil.class)) {

            mockedStatic.when(() ->
                            OfferProductUtil.getMpcCodeList(offerProductId, resourceResolver))
                    .thenReturn(Collections.emptyList());

            servlet.doGet(request, response);

            String json = out.toString().trim();
            assertEquals("[]", json);
        }
    }

    @Test
    public void testDoGet_withoutQueryParam_returnsBadRequest() throws Exception {

        when(resourceResolvers.getResourceResolver(SubService.READ_CONTENT))
                .thenReturn(resourceResolver);
        when(request.getParameter(OFFER_PRODUCT_ID_QUERY_PARAM)).thenReturn(null);

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        prepareWriter(out);

        servlet.doGet(request, response);

        String body = out.toString().trim();
        assertTrue(body.contains("No query parameter found"));
        verify(response).setStatus(HttpServletResponse.SC_BAD_REQUEST);
    }
}
