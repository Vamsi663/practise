(function ($, $document, author) {
    "use strict";

    $document.on("foundation-contentloaded", function (e) {
        Coral.commons.ready(this, function (el) {

            // ------------------------------
            // Make fields read-only
            // ------------------------------
            var $textField = $(".bcusReadOnlyDialogField");
            $textField.prop("readonly", true);
            $textField.attr("readonly", true);

            // ------------------------------
            // Remove Delete Buttons
            // ------------------------------
            // Coral 2 delete
            $(".bcus-hide-multifield-delete button.js-coral-Multifield-remove.coral-Multifield-remove").remove();
            // Coral 3 delete
            $(".bcus-hide-multifield-delete button.coral3-Button.coral3-Button--quiet.coral3-Multifield-remove").remove();

            // Vanity URL delete button
            $(".vanity-url-delete .coral3-Multifield-item button.coral3-Button.coral3-Multifield-remove").remove();

            // ------------------------------
            // DELETE VANITY URL LOGIC
            // ------------------------------
            $(".deleteVanityUrlAssociation button.coral3-Multifield-remove").click(function () {

                // Get offer product id from this multifield row
                var offerProdId = $(this).parent().find("input.primaryOfferProductId").val();

                // -------------------------------------------
                // OLD LOGIC — delete URLs containing offerProdId
                // -------------------------------------------
                $("input[name='./sling:vanityPath']").each(function () {
                    var vanity = this.value || "";

                    if (vanity.indexOf(offerProdId) !== -1) {
                        $(this).parent().closest("coral-multifield-item").remove();
                        $(this).parent().closest("li").remove(); // Coral 2 fallback
                    }
                });

                // If no vanity fields exist, nothing more to do
                if ($("input[name='./sling:vanityPath']").length === 0) {
                    return;
                }

                // -------------------------------------------
                // NEW LOGIC — MPC URLs (optimized using Set)
                // -------------------------------------------
                $.ajax({
                    url: "/bin/bcuspublic/offerproductmpccodes",
                    type: "GET",
                    dataType: "json",
                    data: { offerProductId: offerProdId }
                }).done(function (mpcCodes) {

                    if (!mpcCodes || !mpcCodes.length) {
                        return;
                    }

                    // Convert array → Set for O(1) lookup
                    var mpcSet = new Set(mpcCodes);

                    // Check each vanity path for MPC code match
                    $("input[name='./sling:vanityPath']").each(function () {

                        var vanity = this.value || "";
                        var lastSlash = vanity.lastIndexOf("/");
                        var lastSeg = (lastSlash === -1) ? vanity : vanity.substring(lastSlash + 1);

                        if (mpcSet.has(lastSeg)) {
                            $(this).parent().closest("coral-multifield-item").remove();
                            $(this).parent().closest("li").remove();
                        }
                    });
                });

            });

            // ------------------------------
            // Remove Add Buttons
            // ------------------------------
            // Coral 2 add
            $(".bcus-hide-multifield-add button.js-coral-Multifield-add.coral-Multifield-add.coral-Button").remove();
            // Coral 3 add
            $(".bcus-hide-multifield-add button.coral3-Button.coral3-Button--secondary").remove();

        });
    });

})(jQuery, jQuery(document), Granite.author);
