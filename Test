@RunWith(PowerMockRunner.class)
@PrepareForTest({ OfferProductUtil.class, CmaHelperUtils.class, CmaMessageAreaListUtil.class })
public class CMAPagePublishListenerJobTest {

  @Mock private ResourceResolvers resourceResolvers;
  @Mock private ResourceResolver resourceResolver;
  @Mock private Job job;
  @Mock private KafkaProducerConfig kafkaProducerConfig;
  @Mock private KafkaPublisher kafkaPublisher;

  @InjectMocks private CMAPagePublishListenerJob cmaPagePublishListenerJob;

  @Before
  public void setUp() throws Exception {
    MockitoAnnotations.openMocks(this);

    when(job.getProperty("pagePath", String.class)).thenReturn("/content/site/en/test");
    when(resourceResolvers.getResourceResolver(any())).thenReturn(resourceResolver);
    when(kafkaProducerConfig.topic()).thenReturn("topic");

    PowerMockito.mockStatic(OfferProductUtil.class);
    PowerMockito.mockStatic(CmaHelperUtils.class);
    PowerMockito.mockStatic(CmaMessageAreaListUtil.class);
  }

  @Test
  public void processJobTest() {
    String pagePath = "/content/site/en/test";

    List<String> offerProductIds = Arrays.asList("OP1");
    List<String> mpcCodeList = Arrays.asList("MPC1", "MPC2");

    JsonArray msgList = new JsonArray();
    msgList.add(new JsonObject());

    PowerMockito.when(OfferProductUtil.getOfferProductIds(eq(pagePath), eq(resourceResolver)))
        .thenReturn(offerProductIds);

    PowerMockito.when(CmaHelperUtils.getMpcCodeList(eq("OP1"), eq(resourceResolver)))
        .thenReturn(mpcCodeList);

    PowerMockito.when(CmaMessageAreaListUtil.getMessageAreaListJson(anyString(), eq(resourceResolver)))
        .thenReturn(msgList);

    JobResult result = cmaPagePublishListenerJob.process(job);

    assertEquals(JobResult.OK, result);
    verify(kafkaPublisher, times(1)).publishEvent(anyString(), eq("topic"));
  }
}
