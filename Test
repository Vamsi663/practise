(function ($, $document) {
    "use strict";

    $document.on("foundation-contentloaded", function () {

        $(".deleteVanityUrlAssociation button.coral3-Multifield-remove").click(function () {

            var $row = $(this).closest("coral-multifield-item");
            var offerProdId = $row.find(".primaryOfferProductId").val();

            if (!offerProdId) return;

            var offerProdIdLc = offerProdId.toLowerCase();

            // function to delete vanity items
            function deleteVanity(predicate) {
                $("input[name='./sling:vanityPath']").each(function () {
                    var vanity = (this.value || "").toLowerCase();
                    if (predicate(vanity)) {
                        $(this).closest("coral-multifield-item").remove();
                        $(this).closest("li").remove();
                    }
                });
            }

            // ------- STEP 1: Try OLD LOGIC (delete by offerProductId) -------
            var oldPatternMatched = false;

            $("input[name='./sling:vanityPath']").each(function () {
                var vanity = (this.value || "").toLowerCase();
                if (vanity.indexOf(offerProdIdLc) !== -1) {
                    oldPatternMatched = true;
                }
            });

            if (oldPatternMatched) {
                // Delete using old logic, NO AJAX needed
                deleteVanity(function (vanity) {
                    return vanity.indexOf(offerProdIdLc) !== -1;
                });
                return; // STOP HERE
            }

            // ------- STEP 2: Only if old-style URLs weren't found â†’ use MPC logic -------

            $.ajax({
                url: "/bin/bcuspublic/offerproductmpccodes",
                type: "GET",
                dataType: "json",
                data: { offerProductId: offerProdId }
            }).done(function (mpcCodes) {

                if (!mpcCodes || !mpcCodes.length) return;

                var mpcLower = mpcCodes.map(code => code.toLowerCase());

                deleteVanity(function (vanity) {
                    var lastSeg = vanity.substring(vanity.lastIndexOf("/") + 1);
                    return mpcLower.indexOf(lastSeg) !== -1;
                });
            });

        });

    });

})($, $(document));
