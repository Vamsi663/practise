$(".deleteVanityUrlAssociation button.coral3-Multifield-remove").click(function () {

    var $btn = $(this);

    // if another handler already processed this click, just exit
    if ($btn.data("vanityDeleteHandled")) {
        return;
    }
    // mark this button as handled for this click
    $btn.data("vanityDeleteHandled", true);

    // get offer product id from this multifield item
    var $item = $btn.closest("coral-multifield-item");
    var offerProdId = $item.find("input.primaryOfferProductId").val();

    if (!offerProdId) {
        return;
    }

    var offerProdIdLc = offerProdId.toLowerCase();

    // helper: delete vanity multifield items matching predicate
    function deleteVanity(predicate) {
        $("input[name='./sling:vanityPath']").each(function () {
            var vanity = (this.value || "").toLowerCase();
            if (predicate(vanity)) {
                $(this).closest("coral-multifield-item").remove();
                $(this).closest("li").remove(); // coral2 fallback
            }
        });
    }

    // ---------- 1) OLD LOGIC ----------
    var oldPatternMatched = false;

    $("input[name='./sling:vanityPath']").each(function () {
        var vanity = (this.value || "").toLowerCase();
        if (vanity.indexOf(offerProdIdLc) !== -1) {
            oldPatternMatched = true;
            return false; // break
        }
    });

    if (oldPatternMatched) {
        deleteVanity(function (vanity) {
            return vanity.indexOf(offerProdIdLc) !== -1;
        });
        return;
    }

    if ($("input[name='./sling:vanityPath']").length === 0) {
        return;
    }

    // ---------- 2) NEW LOGIC ----------
    $.ajax({
        url: "/bin/bcuspublic/offerproductmpccodes",
        type: "GET",
        dataType: "json",
        data: {
            offerProductId: offerProdId
        }
    }).done(function (mpcCodes) {

        if (!mpcCodes || !mpcCodes.length) {
            return;
        }

        var mpcLower = $.map(mpcCodes, function (code) {
            return (code || "").toLowerCase();
        });

        deleteVanity(function (vanity) {
            var lastSeg = vanity.substring(vanity.lastIndexOf("/") + 1);
            return mpcLower.indexOf(lastSeg) !== -1;
        });
    });
});
