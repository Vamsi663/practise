@Test
public void testCreateMomProductNode() throws Exception {

    // --- Spy the util ---
    OfferProductUtil util = Mockito.spy(new OfferProductUtil());

    // --- Mock session ---
    Session session = mock(Session.class);

    // --- Mock offerProduct and list of codes ---
    OfferProduct offerProduct = mock(OfferProduct.class);

    MomProductCode code1 = new MomProductCode();
    code1.setMomProductCode("momCode_123");
    MomProductCode code2 = new MomProductCode();
    code2.setMomProductCode("momCode_456");

    when(offerProduct.getMomProductCodeVO())
            .thenReturn(Arrays.asList(code1, code2));

    // --- Base node and bucket nodes ---
    Node baseNode = mock(Node.class);
    Node bucketNode = mock(Node.class);
    when(bucketNode.getName()).thenReturn("m");

    Node leaf1 = mock(Node.class);
    Node leaf2 = mock(Node.class);

    // --- Stub createNode for base folder ---
    doReturn(baseNode)
            .when(util)
            .createNode(contains("/momProductCodes"), eq(session), eq(false));

    // --- Stub bucket folder creation ---
    doReturn(bucketNode)
            .when(util)
            .getOrCreateFolder(eq(baseNode), eq("m"));

    // --- Stub leaf node creation ---
    doReturn(leaf1)
            .when(util)
            .createNode(contains("momCode_123"), eq(session), eq(false));

    doReturn(leaf2)
            .when(util)
            .createNode(contains("momCode_456"), eq(session), eq(false));

    // --- IMPORTANT: skip JcrUtil writing ---
    doNothing()
            .when(util)
            .createMomProductCodeListNode(any(Node.class), any(MomProductCode.class));

    // --- ACT ---
    util.createMomProductNode(offerProduct, session);

    // --- ASSERT ---
    // base folder created once
    verify(util, times(1))
            .createNode(contains("/momProductCodes"), eq(session), eq(false));

    // bucket created twice (same bucket 'm' for both codes)
    verify(util, times(2))
            .getOrCreateFolder(baseNode, "m");

    // leaf nodes created
    verify(util).createNode(contains("momCode_123"), eq(session), eq(false));
    verify(util).createNode(contains("momCode_456"), eq(session), eq(false));

    // listNode method called twice for 2 codes
    verify(util, times(2))
            .createMomProductCodeListNode(any(Node.class), any(MomProductCode.class));
}
