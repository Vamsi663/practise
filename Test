// ORIGINAL binding style â€“ keep this
$(".deleteVanityUrlAssociation button.coral3-Multifield-remove").click(function () {

    // use the same parent() as your original working JS
    var $container = $(this).parent();

    // get offer product id from this row (same as original)
    if (!$container.find("input.primaryOfferProductId").length) {
        return;
    }
    var offerProdId = $container.find("input.primaryOfferProductId").val();
    if (!offerProdId) {
        return;
    }
    var offerProdIdLc = offerProdId.toLowerCase();

    // helper: delete vanity multifield items matching predicate
    function deleteVanity(predicate) {
        $("input[name='./sling:vanityPath']").each(function () {
            var vanity = (this.value || "").toLowerCase();
            if (predicate(vanity)) {
                $(this).parent().closest("coral-multifield-item").remove();
                $(this).parent().closest("li").remove(); // coral2 fallback
            }
        });
    }

    // ---------------- 1) OLD LOGIC: vanity contains offerProductId ----------------
    var oldPatternMatched = false;

    $("input[name='./sling:vanityPath']").each(function () {
        var vanity = (this.value || "").toLowerCase();
        if (vanity.indexOf(offerProdIdLc) !== -1) {
            oldPatternMatched = true;
            // delete directly (original behaviour)
            $(this).parent().closest("coral-multifield-item").remove();
            $(this).parent().closest("li").remove();
        }
    });

    if (oldPatternMatched) {
        // if we found old-style vanity URLs and already removed them,
        // we don't need the servlet at all
        return;
    }

    // if there are no vanity URLs at all, nothing to do
    if ($("input[name='./sling:vanityPath']").length === 0) {
        return;
    }

    // -------------- 2) NEW LOGIC: vanity ends with MPC codes --------------
    $.ajax({
        url: "/bin/bcuspublic/offerproductmpccodes",
        type: "GET",
        dataType: "json",
        data: {
            offerProductId: offerProdId
        }
    }).done(function (mpcCodes) {

        if (!mpcCodes || !mpcCodes.length) {
            return;
        }

        var mpcLower = $.map(mpcCodes, function (code) {
            return (code || "").toLowerCase();
        });

        deleteVanity(function (vanity) {
            var lastSeg = vanity.substring(vanity.lastIndexOf("/") + 1); // "mpc1"
            return mpcLower.indexOf(lastSeg) !== -1;
        });
    });

});
